import axios from 'axios';

const handler = async (m, { conn, text, usedPrefix, command }) => {
    // Daftar resolusi yang umum atau bisa kamu sesuaikan
    const resolutions = [
        'Portrait', 'Landscape', 'Square' // Sesuaikan dengan yang didukung API epicanime
    ];

    let prompt = null;
    let selectedResolution = 'Portrait'; // Default resolution

    // Ambil domain dan API Key Maelyn dari global.maelyn di config.js
    const maelynDomain = global.maelyn.domain;
    const maelynApiKey = global.maelyn.key;

    // Lakukan validasi dasar untuk memastikan konfigurasi ada
    if (!maelynDomain || !maelynApiKey) {
        throw 'API Key atau Domain Maelyn belum diatur di config.js! Mohon hubungi pemilik bot.';
    }

    // --- LOGIC UNTUK PARSING INPUT ---
    if (!text) {
        throw `Hai! Aku bisa membuat gambar anime epik dari teks.\n\nContoh: *${usedPrefix}${command} Pahlawan pedang di medan perang | resolusi:Landscape*\n\n*Pilihan Resolusi:* ${resolutions.join(', ')}\n(Default Resolusi: ${selectedResolution})`;
    }

    const parts = text.split('|').map(s => s.trim());
    prompt = parts[0]; // Bagian pertama selalu prompt

    for (let i = 1; i < parts.length; i++) {
        const part = parts[i];
        if (part.toLowerCase().startsWith('resolusi:') || part.toLowerCase().startsWith('resolution:')) {
            const resName = part.substring(part.indexOf(':') + 1).trim();
            const foundRes = resolutions.find(r => r.toLowerCase() === resName.toLowerCase());
            if (foundRes) {
                selectedResolution = foundRes;
            } else {
                conn.reply(m.chat, `‚ö†Ô∏è Resolusi '${resName}' tidak valid. Menggunakan resolusi default: ${selectedResolution}.`, m);
            }
        }
    }

    if (!prompt) {
        throw `Prompt tidak boleh kosong!\n\nContoh: *${usedPrefix}${command} Pahlawan pedang di medan perang | resolusi:Landscape*`;
    }

    await conn.sendMessage(m.chat, { react: { text: 'üçè', key: m.key } }); // Reaksi loading

    try {
        // Encode prompt dan resolusi untuk keamanan URL
        const encodedPrompt = encodeURIComponent(prompt);
        const encodedResolution = encodeURIComponent(selectedResolution);

        // Bangun URL API
        const apiUrl = `${maelynDomain}/api/txt2img/epicanime?prompt=${encodedPrompt}&resolution=${encodedResolution}&apikey=${maelynApiKey}`;

        // Kirim permintaan GET ke Maelyn API
        const response = await axios.get(apiUrl);
        const { status, result, code } = response.data;

        if (status === 'Success' && code === 200 && Array.isArray(result) && result.length > 0) {
            await conn.sendMessage(m.chat, { react: { text: '‚úÖ', key: m.key } }); // Reaksi sukses

            // Kirim setiap gambar yang ada di array result
            for (const imageUrl of result) {
                await conn.sendMessage(m.chat, { 
                    image: { url: imageUrl },
                    caption: `‚ú® *Epic Anime Generated*\n\n*Prompt:* ${prompt}\n*Resolusi:* ${selectedResolution}\n\n_Generated by Maelyn API_`
                }, { quoted: m });
            }
        } else {
            await conn.sendMessage(m.chat, { react: { text: '‚ùå', key: m.key } }); // Reaksi gagal
            m.reply(`‚ùå Gagal menghasilkan gambar epic anime. Respon API: ${JSON.stringify(response.data)}`);
        }
    } catch (e) {
        console.error(e);
        await conn.sendMessage(m.chat, { react: { text: '‚ùå', key: m.key } }); // Reaksi error
        m.reply(`Terjadi kesalahan saat menghubungi Epic Anime Generator API: ${e.message}`);
    }
};

handler.help = ['epicanime', 'txt2epicanime'];
handler.tags = ['ai'];
handler.command = /^(epicanime|txt2epicanime)$/i;
handler.limit = true; // Batasi penggunaan jika perlu
handler.premium = false; // Hanya untuk pengguna non-premium jika perlu

export default handler;